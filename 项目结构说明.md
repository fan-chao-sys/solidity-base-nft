# 项目结构说明

## 📁 项目目录结构

```
solidity-base-nft/
│
├── contracts/                    # Solidity 合约源码
│   ├── localTest/               # 本地测试合约
│   │   ├── MockPriceFeed.sol   # 模拟价格预言机（用于本地测试）
│   │   ├── NFT.sol             # ERC721 NFT 合约
│   │   └── USDC.sol            # ERC20 USDC 代币合约（6位小数）
│   ├── NFTAuction.sol          # NFT拍卖合约（V1，可升级）
│   ├── NFTAuctionFactory.sol   # 拍卖工厂合约（创建拍卖实例）
│   └── NFTAuctionV2.sol         # NFT拍卖合约（V2，升级版本）
│
├── deploy/                      # 部署脚本目录
│   ├── .cache/                 # 部署信息缓存
│   │   └── NFTAuction_deployment.json  # 保存部署的合约地址等信息
│   └── deploy_auction_Local.js  # 首次部署脚本（部署所有基础合约）
│
├── scripts/                     # 工具脚本目录
│   ├── clean-local.js          # 清理本地部署记录
│   ├── deploy-and-upgrade.js   # 部署+升级组合脚本
│   └── upgrade_deploy.js        # 升级脚本（部署V2并更新工厂）
│
├── test/                        # 测试文件目录
│   ├── auction_Local.js         # 完整测试脚本（测试拍卖流程和升级验证）
│   └── deploy-upgrade-test.js   # 完整流程脚本（部署+升级+测试）
│
│
├── hardhat.config.js            # Hardhat 配置文件
├── package.json                 # 项目依赖和脚本配置
├── package-lock.json            # 依赖版本锁定文件
├── README.md                    # 项目说明文档
└── 作业要求.txt                 # 作业需求文档
```

---

## 📄 文件详细说明

### 合约文件 (contracts/)

#### `contracts/localTest/`
- **MockPriceFeed.sol** - 模拟 Chainlink 价格预言机，用于本地测试环境
- **NFT.sol** - ERC721 标准的 NFT 合约，支持铸造和转移
- **USDC.sol** - ERC20 标准的 USDC 代币合约，6位小数，支持铸造

#### `contracts/`
- **NFTAuction.sol** - NFT 拍卖核心合约（V1版本）
  - 支持创建拍卖、竞价（ETH/ERC20）、结束拍卖
  - 使用 UUPS 可升级代理模式
  - 集成价格预言机进行跨币种价格比较
  
- **NFTAuctionFactory.sol** - 拍卖工厂合约
  - 用于创建新的拍卖实例
  - 管理实现合约地址
  - 支持更新实现合约地址（用于升级）
  
- **NFTAuctionV2.sol** - NFT 拍卖合约升级版本
  - 继承自 NFTAuction
  - 新增 `getVersion()` 函数用于验证升级

---

### 部署脚本 (deploy/)

#### `deploy/deploy_auction_Local.js`
- **作用**: 首次部署所有合约
- **功能**:
  - 部署 NFT 和 USDC 合约
  - 铸造初始资产（NFT给Alice，USDC给Bob）
  - 部署 NFTAuction 实现合约（UUPS代理）
  - 部署价格预言机（MockPriceFeed）
  - 部署 NFTAuctionFactory 合约
  - 保存部署信息到 `.cache/NFTAuction_deployment.json`

#### `deploy/.cache/NFTAuction_deployment.json`
- **作用**: 存储部署信息
- **内容**: 所有合约地址、账户地址、价格预言机地址等

---

### 工具脚本 (scripts/)

#### `scripts/clean-local.js`
- **作用**: 清理本地部署记录和缓存
- **使用**: `npm run clean:local` 或 `npx hardhat run scripts/clean-local.js`

#### `scripts/upgrade_deploy.js`
- **作用**: 升级合约到 V2 版本
- **功能**:
  - 部署 NFTAuctionV2 实现合约
  - 更新工厂中的实现合约地址
  - 更新部署信息文件

#### `scripts/deploy-and-upgrade.js`
- **作用**: 部署 + 升级组合脚本
- **功能**: 在同一个网络会话中执行部署和升级

#### `scripts/deploy-upgrade-test.js`
- **作用**: 完整流程脚本（推荐使用）
- **功能**: 在同一个网络会话中执行部署、升级和测试

---

### 测试文件 (test/)

#### `test/auction_Local.js`
- **作用**: 完整的拍卖流程测试
- **测试步骤**:
  1. Alice 授权 NFT 给工厂
  2. Alice 创建拍卖
  3. 设置价格预言机
  4. Bob 使用 USDC 出价
  5. Carol 使用 ETH 出价（超过Bob）
  6. 验证 Bob 的 USDC 被退回
  7. 结束拍卖
  8. 验证最终状态（NFT转移、资金分配）
  9. 验证合约升级（调用 getVersion()）

---

### 配置文件

#### `hardhat.config.js`
- **作用**: Hardhat 框架配置文件
- **配置内容**:
  - Solidity 编译器版本和优化设置
  - 命名账户配置（deployer, alice, bob, carol）
  - 插件配置（hardhat-deploy, hardhat-upgrades）

#### `package.json`
- **作用**: 项目依赖和脚本配置
- **主要脚本**:
  - `clean:local` - 清理本地部署记录
  - `deploy:local` - 部署合约
  - `test:local` - 运行测试
  - `deploy-upgrade-test` - 完整流程（部署+升级+测试）

---

## 🚀 使用方式

### 方式1：完整流程（推荐）
```bash
npx hardhat run scripts/deploy-upgrade-test.js
```

### 方式2：分步执行
```bash
# 1. 部署
npx hardhat deploy --tags auction

# 2. 升级
npx hardhat run scripts/upgrade_deploy.js

# 3. 测试
npx hardhat run test/auction_Local.js
```

### 方式3：使用 npm 脚本
```bash
npm run deploy:local      # 部署
npm run test:local       # 测试
npm run clean:local      # 清理
npm run deploy-upgrade-test  # 完整流程
```

---

## 📦 自动生成的目录（无需管理）

- `artifacts/` - 编译后的合约 ABI 和字节码
- `cache/` - Hardhat 编译缓存
- `deployments/` - hardhat-deploy 的部署记录
- `node_modules/` - 依赖包

这些目录会在编译/部署时自动生成，可以忽略或添加到 `.gitignore`。

---

## ⚠️ 注意事项

1. **网络会话问题**: `npx hardhat deploy` 和 `npx hardhat run` 使用不同的网络实例，建议使用组合脚本
2. **部署记录**: 如果遇到 "cannot get transaction" 错误，运行 `npm run clean:local` 清理
3. **升级验证**: 只有升级后新创建的拍卖会使用 V2 版本，已存在的拍卖仍使用 V1

