# 项目结构说明

## 📁 项目目录结构

```
solidity-base-nft/
│
├── contracts/                    # Solidity 合约源码
│   ├── localTest/               # 本地测试合约
│   │   ├── MockPriceFeed.sol   # 模拟价格预言机（用于本地测试）
│   │   ├── NFT.sol             # ERC721 NFT 合约
│   │   └── USDC.sol            # ERC20 USDC 代币合约（6位小数）
│   ├── NFTAuction.sol          # NFT拍卖合约（V1，可升级）
│   ├── NFTAuctionFactory.sol   # 拍卖工厂合约（创建拍卖实例）
│   └── NFTAuctionV2.sol         # NFT拍卖合约（V2，升级版本）
│
├── deploy/                      # 部署脚本目录
│   ├── .cache/                 # 部署信息缓存
│   │   └── NFTAuction_deployment.json  # 保存部署的合约地址等信息
│   └── deploy_auction_Local.js  # 首次部署脚本（部署所有基础合约）
│
├── scripts/                     # 工具脚本目录
│   ├── clean-local.js          # 清理本地部署记录
│   ├── deploy-and-upgrade.js   # 部署+升级组合脚本
│   └── upgrade_deploy.js        # 升级脚本（部署V2并更新工厂）
│
├── test/                        # 测试文件目录
│   ├── auction_Local.js         # 完整测试脚本（测试拍卖流程和升级验证）
│   └── deploy-upgrade-test.js   # 完整流程脚本（部署+升级+测试）
│
│
├── hardhat.config.js            # Hardhat 配置文件
├── package.json                 # 项目依赖和脚本配置
├── package-lock.json            # 依赖版本锁定文件
├── README.md                    # 项目说明文档
└── 作业要求.txt                 # 作业需求文档
```

---

## 📄 文件详细说明

### 合约文件 (contracts/)

#### `contracts/localTest/`
- **MockPriceFeed.sol** - 模拟 Chainlink 价格预言机，用于本地测试环境
- **NFT.sol** - ERC721 标准的 NFT 合约，支持铸造和转移
- **USDC.sol** - ERC20 标准的 USDC 代币合约，6位小数，支持铸造

#### `contracts/`
- **NFTAuction.sol** - NFT 拍卖核心合约（V1版本）
  - 支持创建拍卖、竞价（ETH/ERC20）、结束拍卖
  - 使用 UUPS 可升级代理模式
  - 集成价格预言机进行跨币种价格比较
  
- **NFTAuctionFactory.sol** - 拍卖工厂合约
  - 用于创建新的拍卖实例
  - 管理实现合约地址
  - 支持更新实现合约地址（用于升级）
  
- **NFTAuctionV2.sol** - NFT 拍卖合约升级版本
  - 继承自 NFTAuction
  - 新增 `getVersion()` 函数用于验证升级

---

### 部署脚本 (deploy/)

#### `deploy/deploy_auction_Local.js`
- **作用**: 首次部署所有合约
- **功能**:
  - 部署 NFT 和 USDC 合约
  - 铸造初始资产（NFT给Alice，USDC给Bob）
  - 部署 NFTAuction 实现合约（UUPS代理）
  - 部署价格预言机（MockPriceFeed）
  - 部署 NFTAuctionFactory 合约
  - 保存部署信息到 `.cache/NFTAuction_deployment.json`

#### `deploy/.cache/NFTAuction_deployment.json`
- **作用**: 存储部署信息
- **内容**: 所有合约地址、账户地址、价格预言机地址等

---

### 工具脚本 (scripts/)

#### `scripts/clean-local.js`
- **作用**: 清理本地部署记录和缓存
- **使用**: `npm run clean:local` 或 `npx hardhat run scripts/clean-local.js`

#### `scripts/upgrade_deploy.js`
- **作用**: 升级合约到 V2 版本
- **功能**:
  - 部署 NFTAuctionV2 实现合约
  - 更新工厂中的实现合约地址
  - 更新部署信息文件

#### `scripts/deploy-and-upgrade.js`
- **作用**: 部署 + 升级组合脚本
- **功能**: 在同一个网络会话中执行部署和升级

#### `scripts/deploy-upgrade-test.js`
- **作用**: 完整流程脚本（推荐使用）
- **功能**: 在同一个网络会话中执行部署、升级和测试

---

### 测试文件 (test/)

#### `test/auction_Local.js`
- **作用**: 完整的拍卖流程测试
- **测试步骤**:
  1. Alice 授权 NFT 给工厂
  2. Alice 创建拍卖
  3. 设置价格预言机
  4. Bob 使用 USDC 出价
  5. Carol 使用 ETH 出价（超过Bob）
  6. 验证 Bob 的 USDC 被退回
  7. 结束拍卖
  8. 验证最终状态（NFT转移、资金分配）
  9. 验证合约升级（调用 getVersion()）

---

### 配置文件

#### `hardhat.config.js`
- **作用**: Hardhat 框架配置文件
- **配置内容**:
  - Solidity 编译器版本和优化设置
  - 命名账户配置（deployer, alice, bob, carol）
  - 插件配置（hardhat-deploy, hardhat-upgrades）

#### `package.json`
- **作用**: 项目依赖和脚本配置
- **主要脚本**:
  - `clean:local` - 清理本地部署记录
  - `deploy:local` - 部署合约
  - `test:local` - 运行测试
  - `deploy-upgrade-test` - 完整流程（部署+升级+测试）

---

## 🚀 使用方式

### 方式1：完整流程（推荐）
```bash
npx hardhat run scripts/deploy-upgrade-test.js
```

### 方式2：分步执行
```bash
# 1. 部署
npx hardhat deploy --tags auction

# 2. 升级
npx hardhat run scripts/upgrade_deploy.js

# 3. 测试
npx hardhat run test/auction_Local.js
```

### 方式3：使用 npm 脚本
```bash
npm run deploy:local      # 部署
npm run test:local       # 测试
npm run clean:local      # 清理
npm run deploy-upgrade-test  # 完整流程
```

---

## 📦 自动生成的目录（无需管理）

- `artifacts/` - 编译后的合约 ABI 和字节码
- `cache/` - Hardhat 编译缓存
- `deployments/` - hardhat-deploy 的部署记录
- `node_modules/` - 依赖包

这些目录会在编译/部署时自动生成，可以忽略或添加到 `.gitignore`。

---

## ⚠️ 注意事项

1. **网络会话问题**: `npx hardhat deploy` 和 `npx hardhat run` 使用不同的网络实例，建议使用组合脚本
2. **部署记录**: 如果遇到 "cannot get transaction" 错误，运行 `npm run clean:local` 清理
3. **升级验证**: 只有升级后新创建的拍卖会使用 V2 版本，已存在的拍卖仍使用 V1

---

## 🚀 部署到测试网络步骤

### 前置准备

1. **配置环境变量**
   
   在项目根目录创建 `.env` 文件：
   ```env
   INFURA_API_KEY=你的Infura_API密钥
   PRIVATE_KEY1=0x你的私钥1（deployer）
   PRIVATE_KEY2=0x你的私钥2（alice，可选）
   PRIVATE_KEY3=0x你的私钥3（bob，可选）
   PRIVATE_KEY4=0x你的私钥4（carol，可选）
   ```
   
   > 注意：如果只配置一个私钥，脚本会自动使用该账户作为所有角色

2. **安装依赖**
   ```bash
   npm install
   ```

3. **确保账户有足够的测试ETH**
   - 部署者账户需要足够的ETH支付gas费
   - 建议至少0.1 ETH（Sepolia测试网）

### 部署步骤

#### 步骤1: 部署基础合约
```bash
npx hardhat deploy --network sepolia --tags auction
```

**部署内容**:
- NFT合约
- USDC合约
- NFTAuction实现合约（V1）
- MockPriceFeed价格预言机（2个：ETH/USD, USDC/USD）
- NFTAuctionFactory工厂合约

**部署信息保存位置**: `deploy/.cache/NFTAuction_deployment.json`

#### 步骤2: 升级合约（可选）
```bash
npx hardhat run deploy/upgrade_auction_Local.js --network sepolia
```

**升级内容**:
- 部署NFTAuctionV2实现合约
- 更新Factory中的实现合约地址

#### 步骤3: 运行测试（验证部署）
```bash
npx hardhat run test/auction_Local.js --network sepolia
```

### 部署后验证

1. **检查部署信息文件**
   - 路径: `deploy/.cache/NFTAuction_deployment.json`
   - 确认所有合约地址已正确保存

2. **在Etherscan验证合约**
   - 访问 https://sepolia.etherscan.io
   - 输入合约地址进行验证
   - 查看合约代码和交易记录

3. **使用Remix连接测试**
   - 打开 https://remix.ethereum.org
   - 连接MetaMask（切换到Sepolia网络）
   - 加载合约ABI和地址
   - 进行交互测试

---

## 📍 测试网部署合约地址

### Sepolia测试网络

> **注意**: 以下地址需要在部署后更新。部署完成后，从 `deploy/.cache/NFTAuction_deployment.json` 文件中获取实际地址。

#### 基础合约
- **NFT合约**: `待部署后更新`
- **USDC合约**: `待部署后更新`

#### 核心合约
- **NFTAuction实现合约(V1)**: `待部署后更新`
- **NFTAuction实现合约(V2)**: `待部署后更新`（升级后）
- **NFTAuctionFactory工厂合约**: `待部署后更新`

#### 价格预言机
- **ETH/USD价格预言机**: `待部署后更新`
- **USDC/USD价格预言机**: `待部署后更新`

#### 部署信息
- **部署网络**: Sepolia测试网络
- **部署日期**: `待填写`
- **部署者地址**: `待部署后更新`
- **部署信息文件**: `deploy/.cache/NFTAuction_deployment.json`

### 部署后更新说明

部署完成后，请按以下步骤更新本文档：

1. 执行部署命令
2. 打开 `deploy/.cache/NFTAuction_deployment.json` 文件
3. 将合约地址复制到本文档的对应位置
4. 保存并提交更新

### Etherscan链接格式

部署后可以使用以下格式查看合约：
- NFT合约: `https://sepolia.etherscan.io/address/{NFT合约地址}`
- USDC合约: `https://sepolia.etherscan.io/address/{USDC合约地址}`
- Factory合约: `https://sepolia.etherscan.io/address/{Factory合约地址}`

---

## 📝 部署检查清单

部署前检查：
- [ ] `.env` 文件已配置
- [ ] 账户有足够的测试ETH
- [ ] 依赖已安装 (`npm install`)
- [ ] 合约已编译 (`npx hardhat compile`)

部署后检查：
- [ ] 所有合约部署成功
- [ ] 部署信息文件已生成
- [ ] 合约地址已记录
- [ ] 在Etherscan验证合约
- [ ] 运行测试脚本验证功能
- [ ] 更新本文档中的合约地址

